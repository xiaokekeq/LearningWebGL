<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script id="vertexShader2d" type="x-shader/x-vertex">
        attribute vec4 a_position;
        attribute vec2 a_texcoord;
        uniform mat4 u_matrix;
        varying vec2 v_texcoord;
        void main(){
            gl_Position=u_matrix*a_position;
            v_texcoord=a_texcoord;
        }
    </script>
    <script id="fragmentShader2d" type="x-shader/x-fragment">
        precision mediump float;
        varying vec2 v_texcoord;
        uniform sampler2D u_texture;

        void main(){
            gl_FragColor=texture2D(u_texture,v_texcoord);
        }
    </script>
    <style>
        @import url("https://webglfundamentals.org/webgl/resources/webgl-tutorials.css");

        body {
            margin: 0;
        }

        canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }
    </style>
    <script src="https://webglfundamentals.org/webgl/resources/webgl-utils.js"></script>
    <script src="https://webglfundamentals.org/webgl/resources/m4.js"></script>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script>
        function main() {
            var canvas = document.querySelector("#canvas");
            var gl = canvas.getContext("webgl");
            if (!gl) {
                return;
            }

            var program = webglUtils.createProgramFromScripts(gl, ["vertexShader2d", "fragmentShader2d"]);
            var positionLocation = gl.getAttribLocation(program, "a_position");
            var texcoordLocation = gl.getAttribLocation(program, "a_texcoord");

            var matrixLocation = gl.getUniformLocation(program, "u_matrix");
            var textureLocation = gl.getUniformLocation(program, "u_texture");

            var positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            // Put a 2 unit quad in the buffer
            setGeometry(gl);

            var texcoordBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);
            setTexcoord(gl);

            function requestCORSIfNotSameOrigin(img, url) {
                if ((new URL(url, window.location.href)).origin !== window.location.origin) {
                    img.crossOrigin = "";
                }
            }

            function loadImageAndCreateTextureInfo(url) {
                var tex = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, tex);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,
                    new Uint8Array([0, 0, 255, 255])
                );

                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

                var textureInfo = {
                    width: 1,
                    height: 1,
                    texture: tex
                }

                var img = new Image();
                img.addEventListener("load", () => {
                    textureInfo.width = img.width;
                    textureInfo.height = img.height;
                    gl.bindTexture(gl.TEXTURE_2D, textureInfo.texture);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
                });

                requestCORSIfNotSameOrigin(img, url);
                img.src = url;
                return textureInfo;
            }

            var texInfo = loadImageAndCreateTextureInfo('https://c1.staticflickr.com/9/8873/18598400202_3af67ef38f_q.jpg')

            function render(time) {
                time *= 0.001;
                webglUtils.resizeCanvasToDisplaySize(gl.canvas);

                // Tell WebGL how to convert from clip space to pixels
                gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

                gl.clear(gl.COLOR_BUFFER_BIT);

                gl.bindTexture(gl.TEXTURE_2D, texInfo.texture);

                gl.useProgram(program);


                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.enableVertexAttribArray(positionLocation);
                gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
                gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);
                gl.enableVertexAttribArray(texcoordLocation);
                gl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);


                var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;
                var matrix = m4.scaling(1, aspect, 1);
                matrix = m4.zRotate(matrix, time);
                matrix = m4.scale(matrix, 0.5, 0.5, 1);

                gl.uniformMatrix4fv(matrixLocation, false, matrix);

                gl.uniform1i(textureLocation, 0);

                gl.drawArrays(gl.TRIANGLES, 0, 6);
                requestAnimationFrame(render);

            }
            requestAnimationFrame(render);
        }

        function setGeometry(gl) {
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                -1, -1,
                -1, 1,
                1, -1,
                1, -1,
                -1, 1,
                1, 1,
            ]), gl.STATIC_DRAW);
        }

        function setTexcoord(gl) {
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                0, 0,
                0, 1,
                1, 0,
                1, 0,
                0, 1,
                1, 1,
            ]), gl.STATIC_DRAW);
        }

        main();
    </script>
</body>

</html>